<!DOCTYPE html>
<html lang="en">
  <head>
  
      <title>mcc - The second article</title>

<meta charset="utf-8" />
<meta name="generator" content="Pelican" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<link rel="icon" type="image/x-icon" href="/theme/favicon.ico">

<!-- Core CSS -->
<link rel="stylesheet" href="/theme/css/main.css">





    <meta name="tags" content="Miky" />

  </head>

  <body>
    <div class="flex flex-col min-h-screen">

<header class="sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md shadow-sm">
    <div class="container flex items-center justify-between h-20">
      <a href="/" class="text-2xl font-bold text-primary-800 font-serif flex items-center">
        <span class="sr-only">Church Name</span>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="h-12 w-auto text-primary-600 mr-2">
          <path fill="currentColor" d="M344 24c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 24-32 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l32 0 0 46.4L183.3 210c-14.5 8.7-23.3 24.3-23.3 41.2L160 512l96 0 0-96c0-35.3 28.7-64 64-64s64 28.7 64 64l0 96 96 0 0-260.8c0-16.9-8.8-32.5-23.3-41.2L344 142.4 344 96l32 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-32 0 0-24zM24.9 330.3C9.5 338.8 0 354.9 0 372.4L0 464c0 26.5 21.5 48 48 48l80 0 0-238.4L24.9 330.3zM592 512c26.5 0 48-21.5 48-48l0-91.6c0-17.5-9.5-33.6-24.9-42.1L512 273.6 512 512l80 0z"/>
        </svg>
        <span class="text-primary-800">Church Name</span>
      </a>


<!-- Desktop Navigation -->
<nav class="hidden lg:block">
  <ul class="flex items-center space-x-6 capitalize">

          <li>
            <a
              href="/pages/about.html"
              class="text-base font-medium transition-colors hover:text-primary-600 text-gray-700"
            >
              About
            </a>
          </li>
          <li>
            <a
              href="/"
              class="text-base font-medium transition-colors hover:text-primary-600 text-gray-700"
            >
              I'm New
            </a>
          </li>
          <li>
            <a
              href="/"
              class="text-base font-medium transition-colors hover:text-primary-600 text-gray-700"
            >
              Staff
            </a>
          </li>
          <li>
            <a
              href="/"
              class="text-base font-medium transition-colors hover:text-primary-600 text-gray-700"
            >
              Contact
            </a>
          </li>

    <!-- GitHub Icon -->
    <li>
      <a
        href="https://github.com/"
        target="_blank"
        rel="noopener noreferrer"
        class="text-gray-700 hover:text-primary-600 transition-colors p-2"
        aria-label="View on GitHub"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
      </a>
    </li>
  </ul>
</nav>


<!-- Mobile Menu Button -->
<button
  id="mobile-menu-button"
  class="lg:hidden p-2 text-gray-700 hover:text-primary-600 focus:outline-none transition-colors relative"
  aria-label="Toggle Menu"
  aria-expanded="false"
>
  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
  </svg>
</button>

<!-- Mobile Menu Dropdown - Compact & Clean -->
<div
  id="mobile-menu"
  class="absolute top-full left-0 right-0 bg-white shadow-lg border-t border-gray-100 transform scale-y-0 origin-top transition-transform duration-200 ease-out lg:hidden z-50"
  role="menu"
  aria-labelledby="mobile-menu-button"
>
  <!-- Navigation Links in Grid -->
  <div class="px-4 py-6">
    <div class="grid grid-cols-2 gap-3 capitalize">


          <a
            href="/pages/about.html"
            role="menuitem"
            class="block px-4 py-3 text-sm font-medium rounded-lg transition-colors text-center text-gray-700 hover:bg-gray-50 hover:text-primary-600 border border-transparent"
          >
            About
          </a>
          <a
            href="/"
            role="menuitem"
            class="block px-4 py-3 text-sm font-medium rounded-lg transition-colors text-center text-gray-700 hover:bg-gray-50 hover:text-primary-600 border border-transparent"
          >
            I'm New
          </a>
          <a
            href="/"
            role="menuitem"
            class="block px-4 py-3 text-sm font-medium rounded-lg transition-colors text-center text-gray-700 hover:bg-gray-50 hover:text-primary-600 border border-transparent"
          >
            Staff
          </a>
          <a
            href="/"
            role="menuitem"
            class="block px-4 py-3 text-sm font-medium rounded-lg transition-colors text-center text-gray-700 hover:bg-gray-50 hover:text-primary-600 border border-transparent"
          >
            Contact
          </a>

    </div>

    <!-- GitHub Link -->
    <div class="mt-4 pt-4 border-t border-gray-100">
      <a
        href="https://github.com/"
        target="_blank"
        rel="noopener noreferrer"
        class="flex items-center justify-center px-4 py-3 text-sm font-medium text-gray-600 hover:text-primary-600 transition-colors rounded-lg hover:bg-gray-50"
        role="menuitem"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        View on GitHub
      </a>
    </div>
  </div>
</div>

    </div>
</header>
        <main class="flex-grow">

<section
  class="relative py-20 bg-cover bg-center"
  style="background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('/images/banner-light.webp')"
>
  <div class="container">
    <div class="max-w-3xl mx-auto text-center text-white">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 text-white">
          The second article
      </h1>
    </div>
  </div>
</section>
  <section class="py-8">
    <div class="container mx-auto max-w-3xl">
      <div class="mb-8 overflow-hidden rounded-lg">
        <img
          src="/images/banner-light.webp"
          alt="The second article"
          class="object-cover w-full h-64 md:h-96"
          widths="[320, 640, 1024]"
          format="webp"
          loading="lazy"
        />
      </div>
    </div>
  </section>

  <article class="mx-auto max-w-3xl pb-20">
    <h2>
      <a
        href="/article-2.html" rel="bookmark"
        title="Permalink to The second article"
      >
        The second article
      </a>
    </h2>


    

    <p>I studied LSM trees at university and after encountering them twice in Designing Data-Intensive Applications and Database Internals I decided to implement something in Java.</p>
<p>The idea behind this project is not to provide the most efficient implementation ever, but to experiment with storing data on disk, any suggestions are welcome!</p>
<p>Here’s the Github repo if you want to have a look, this article is also published on Medium.</p>
<p>Introduction 
An LSM tree is a structure used by NoSQL databases, such as Cassandra, RocksDB, LevelDB, Dynamo, and so on. It’s suitable for write-intensive applications.</p>
<p>We can distinguish two key components of the tree, the in-memory buffer, also called Memtable, and the disk-resident tables. The main idea is to accept writes to the in-memory part of the tree, and to flush them periodically, or when a certain size is met.</p>
<p>A key aspect of this structure is ordering, indeed, keys are sorted both in RAM and on disk, enabling logarithmic searches.</p>
<p>For the sake of this project elements in the tree are simple key-value pairs.</p>
<p>Memtable 
Having sorted elements in memory is not a new problem we can exploit any efficient order-preserving data structure for this part, such as Red-Black or AVL trees.</p>
<p>In this particular implementation, I decided to build a Skip List, which provides the same theoretical complexity in the average case of balanced trees, but is straightforward to implement. 1</p>
<p>A Skip List is a multi-leveled linked list. The idea is to have fast lanes between nodes, and, by carefully constructing them, we can reduce the number of links we need to traverse while searching.</p>
<p>skiplist
The list properties are:</p>
<p>elements at level zero are sorted;
the number of levels are 
log
⁡
(
n
)
log(n), where 
n
n is the size of the list;
if a node is at level 
i
i, then is must also be at level 
i
−
1
i−1.
Searching 
Given the above properties, searching is done as follows:</p>
<p>start at the highest level and traverse until the node key is less than the wanted key;
if the successor surpasses the wanted key, go down a level and repeat, else we found the element. Eventually, we’ll reach level zero, and determine if the element is found or not.
Inserting 
Insertion proceeds as follows:</p>
<p>locate the insert position with the same logic as before;
determine a level for the new element;
insert as in a linked list, but at each required level. Note that for this to work we need to keep track of a predecessor buffer while descending levels. This way we can correctly replace successors pointers at each level.
public void add(ByteArrayPair item) {</p>
<div class="highlight"><pre><span></span><code><span class="o">//</span><span class="w"> </span><span class="n">Locate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">element</span><span class="w"> </span><span class="n">keeping</span><span class="w"> </span><span class="n">track</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">predecessors</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="k">level</span>
<span class="n">Node</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sentinel</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">current</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">current</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">compareTo</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">current</span><span class="p">;</span><span class="w"> </span>
<span class="err">}</span>

<span class="o">//</span><span class="w"> </span><span class="nf">Replace</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">possible</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">current</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">current</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">compareTo</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="k">current</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="err">}</span>

<span class="o">//</span><span class="w"> </span><span class="k">Insert</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="k">level</span><span class="p">,</span><span class="w"> </span><span class="n">updating</span><span class="w"> </span><span class="n">predecessors</span>
<span class="n">Node</span><span class="w"> </span><span class="n">newNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">randomLevel</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">newNode</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="n">buffer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="k">next</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>}
Choosing a level 
To determine a level, we can toss a coin and keep going until we get heads. This would require a lot of random generations, a faster way is to generate a single number and use its binary representation as boolean values.</p>
<p>private int randomLevel() {
    int level = 1;
    long n = rn.nextLong();
    while (level &lt; levels &amp;&amp; (n &amp; (1L &lt;&lt; level)) != 0)
        level++;
    return level;
}
SSTable 
A Sorted String Table is a disk-based structure for sorted immutable data. They consist of two main files, one with actual data and another with an index to speed up look-ups.</p>
<p>Indexing and Look-Ups 
Given the data file, searching for a key can be implemented with a full scan. This is tremendously slow on big files, hence we rely on indexing to skip portions of data.</p>
<p>Given a sampling factor 
k
k, we build a sparse index with keys at position 
0
,
k
,
2
k
0,k,2k, and so on. By storing the index in an array we can rely on binary search to find a given offset in the data file, where we can start a linear scan. This permits us to skip a lot of unnecessary comparisons and locate a file portion that likely stores our value.</p>
<p>sstable
Note that we can stop the search as soon as the current element surpasses the wanted one. Below is the code for searching, this implementation is as lazy as possible, meaning that we only read what’s strictly necessary while iterating on the input stream.</p>
<p>public byte[] get(byte[] key) {</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">compare</span><span class="ss">(</span><span class="nv">key</span>,<span class="w"> </span><span class="nv">minKey</span><span class="ss">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">compare</span><span class="ss">(</span><span class="nv">key</span>,<span class="w"> </span><span class="nv">maxKey</span><span class="ss">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="ss">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>

<span class="o">//</span><span class="w"> </span><span class="nv">binary</span><span class="w"> </span><span class="nv">search</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">search</span>
<span class="nv">long</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">getCandidateOffsetIndex</span><span class="ss">(</span><span class="nv">key</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">int</span><span class="w"> </span><span class="nv">remaining</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">sparseSizeCount</span>.<span class="nv">getInt</span><span class="ss">(</span><span class="nv">offsetIndex</span><span class="ss">)</span><span class="c1">;</span>

<span class="o">//</span><span class="w"> </span><span class="nv">move</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="nv">given</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">index</span>
<span class="nv">is</span>.<span class="nv">seek</span><span class="ss">(</span><span class="nv">offset</span><span class="ss">)</span><span class="c1">;</span>

<span class="nv">int</span><span class="w"> </span><span class="nv">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="c1">;</span>
<span class="nv">int</span><span class="w"> </span><span class="nv">searchKeyLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">key</span>.<span class="nv">length</span>,<span class="w"> </span><span class="nv">readKeyLen</span>,<span class="w"> </span><span class="nv">readValueLen</span><span class="c1">;</span>

<span class="nv">byte</span>[]<span class="w"> </span><span class="nv">readKey</span><span class="c1">;</span>
<span class="k">while</span><span class="w"> </span><span class="ss">(</span><span class="nv">cmp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">remaining</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="ss">)</span><span class="w"> </span>{

<span class="w">    </span><span class="nv">remaining</span><span class="o">--</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">readKeyLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">is</span>.<span class="nv">readVByteInt</span><span class="ss">()</span><span class="c1">;</span>

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">gone</span><span class="w"> </span><span class="nv">too</span><span class="w"> </span><span class="nv">far</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">readKeyLen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nv">searchKeyLen</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>
<span class="w">    </span>}

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">gone</span><span class="w"> </span><span class="nv">too</span><span class="w"> </span><span class="nv">short</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">readKeyLen</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">searchKeyLen</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">readValueLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">is</span>.<span class="nv">readVByteInt</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">        </span><span class="nv">is</span>.<span class="nv">skip</span><span class="ss">(</span><span class="nv">readKeyLen</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">readValueLen</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">        </span><span class="k">continue</span><span class="c1">;</span>
<span class="w">    </span>}

<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="nv">read</span><span class="w"> </span><span class="nv">full</span><span class="w"> </span><span class="nv">key</span>,<span class="w"> </span><span class="nv">compare</span>,<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">equal</span><span class="w"> </span><span class="nv">read</span><span class="w"> </span><span class="nv">value</span>
<span class="w">    </span><span class="nv">readValueLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">is</span>.<span class="nv">readVByteInt</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">readKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">is</span>.<span class="nv">readNBytes</span><span class="ss">(</span><span class="nv">readKeyLen</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span><span class="nv">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">compare</span><span class="ss">(</span><span class="nv">key</span>,<span class="w"> </span><span class="nv">readKey</span><span class="ss">)</span><span class="c1">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">cmp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="ss">)</span><span class="w"> </span>{
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nv">is</span>.<span class="nv">readNBytes</span><span class="ss">(</span><span class="nv">readValueLen</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span>}<span class="w"> </span><span class="k">else</span><span class="w"> </span>{
<span class="w">        </span><span class="nv">is</span>.<span class="nv">skip</span><span class="ss">(</span><span class="nv">readValueLen</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">    </span>}
}

<span class="k">return</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>
</code></pre></div>

<p>}
Bloom Filters 
What happens when we search for a key that’s not on disk? We waste a lot of precious CPU cycles on binary searching and seeking on an offset, and iterating until we surpass the wanted key.</p>
<p>To avoid unnecessary operations we can rely on a compact and probabilistic structure such as Bloom Filters. The idea is to have a structure that answers membership queries, having some false positive answers, but no false negatives. We can tune the structure for our particular needs, by specifying a false-positive rate.</p>
<p>So, while looking for a key, we first test for probabilistic membership, and if the answer is negative, we can early return null from the search.</p>
<p>public byte[] get(byte[] key) {
    if (!bloomFilter.mightContain(key))
        return null;
    ...
}
Data layout 
Data is disk-resident, hence we need to define a binary format to follow, with minimal overhead. An SSTable is made of 
n
n elements, where each one of them has a variable length key and value.</p>
<p>Key and value pairs are byte arrays, and to lay them out on disk we encode their length 
l
l, followed by 
l
l bytes. Each integer is written in variable byte encoding, to not waste 32 bits on small numbers. 2</p>
<p>This encoding uses a byte to store a continuation bit and a 7-bit payload containing part of the represented number. For instance, consider the number 
456
456 and its binary representation 
111001000
111001000, the variable byte encoded version is:</p>
<p>∣
1
∣
0000011
∣
0
∣
1001000
∣
∣1∣0000011∣0∣1001000∣</p>
<p>The first byte begins with one, hence that the number is not finished, while the second block starts with zero, indicating no more bytes are needed to decode the current integer.</p>
<p>The index file is a list of keys, so we can use the same length plus payload encoding for it. Each index entry has an offset related to it, specifying the number of bytes to skip in the file to reach it. Those offsets are increasing, so we can use something like delta-encoding to store them. Below is an example of such encoding:
0
,
25
,
76
,
…
0,25,76,…
↓
↓
0
,
(
25
−
0
)
,
(
76
−
25
)
,
…
0,(25−0),(76−25),…
Resulting integers are smaller, thus encoded in fewer bytes.</p>
<p>Finally, Bloom Filters are represented by some hyperparameters and a bit vector, that we can encode as is.</p>
<p>Putting it all together 
We saw how to construct an SStable and how a Skip List works in memory, It is time to combine the two to obtain the final engine.</p>
<p>The main components of the tree are:</p>
<p>in-memory mutable buffer or Memtable: a skip list as presented in the previous paragraphs, with a max size;
in-memory immutable buffers: a list of skip lists containing memtables that need to be flushed to disk;
disk-resident tables: a collection of SSTables obtained from memtables flushing, they are divided into levels, level zero containing the most recent data.
tree
We are going to first see how primitives are defined, and then give an overview of how the tree is maintained, with buffer flushing and table compaction.</p>
<p>Insertion and Search 
To insert a new element we simply add it to the in-memory buffer. If the list does not exceed the maximum size we are done, otherwise the current list is scheduled for disk flushing, and the mutable buffer is re-initialized.</p>
<p>Searching is a bit trickier, and has at most three steps:</p>
<p>query the mutable buffer;
query all the immutable buffers scheduled for flushing;
query all the disk tables starting from level zero and on.
If, at any point, the wanted key is found, we can stop the search.</p>
    <footer>
      <p>Published: <time datetime="2012-12-01T10:02:00+01:00">
        Sat 01 December 2012
      </time></p>
        <address>
          By             <a href="/author/mike.html">Mike</a>
        </address>
        <p>
          Category: <a href="/category/tech.html">Tech</a>
        </p>
        <p>
          Tags:
            <a href="/tag/miky.html">Miky</a>
        </p>
    </footer>
  </article>
        </main>


<footer class="bg-gray-900 text-white pt-16 pb-8">
  <div class="container">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
      <!-- Church Info -->
      <div>
        <div class="mb-4">
          <a href="/" class="text-2xl font-bold text-white font-serif inline-flex items-center">
            <span class="sr-only">Church Name</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="h-12 w-auto text-white mr-2">
              <path fill="currentColor" d="M344 24c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 24-32 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l32 0 0 46.4L183.3 210c-14.5 8.7-23.3 24.3-23.3 41.2L160 512l96 0 0-96c0-35.3 28.7-64 64-64s64 28.7 64 64l0 96 96 0 0-260.8c0-16.9-8.8-32.5-23.3-41.2L344 142.4 344 96l32 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-32 0 0-24zM24.9 330.3C9.5 338.8 0 354.9 0 372.4L0 464c0 26.5 21.5 48 48 48l80 0 0-238.4L24.9 330.3zM592 512c26.5 0 48-21.5 48-48l0-91.6c0-17.5-9.5-33.6-24.9-42.1L512 273.6 512 512l80 0z"/>
            </svg>
            <span>Church Name</span>
          </a>
        </div>

        <address class="not-italic mb-4 text-gray-300">
          <p>123 Main Street</p>
          <p>Anytown, ST 12345</p>
          <p class="mt-2">
            <a href="tel:+15551234567" class="hover:text-primary-300">(555) 123-4567</a>
          </p>
          <p>
            <a href="mailto:info@churchname.org" class="hover:text-primary-300">info@churchname.org</a>
          </p>
        </address>

        <!-- Office Hours -->
        <div class="mt-4 text-gray-300">
          <h4 class="text-sm font-bold mb-2 text-white">Office Hours</h4>

            <div class="text-sm prose prose-sm prose-invert max-w-none [&_h3]:text-white [&_h3]:text-sm [&_h3]:font-bold [&_h3]:mb-2 [&_ul]:list-none [&_ul]:p-0 [&_li]:mb-1 [&_strong]:text-white">
              
    <div><strong class="text-white">Mon-Fri:</strong> 9:00 AM - 5:00 PM</div>
    <div><strong class="text-white">Saturday:</strong> 9:00 AM - 1:00 PM</div>
    <div><strong class="text-white">Sunday:</strong> Closed (except services)</div>

            </div>
        </div>

        <!-- Social Links -->
        <div class="flex space-x-4 mt-6">
            <a
              href="https://facebook.com"
              target="_blank"
              rel="noopener noreferrer"
              class="text-gray-400 hover:text-white transition-colors"
              aria-label="Facebook"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            </a>
            <a
              href="https://instagram.com"
              target="_blank"
              rel="noopener noreferrer"
              class="text-gray-400 hover:text-white transition-colors"
              aria-label="Instagram"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
            </a>
            <a
              href="https://youtube.com"
              target="_blank"
              rel="noopener noreferrer"
              class="text-gray-400 hover:text-white transition-colors"
              aria-label="Youtube"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
            </a>
        </div>
      </div>

      <!-- Navigation Groups -->
        <div>
          <h4 class="text-lg font-bold mb-4 text-white">About</h4>
          <ul class="space-y-2">
              <li>
                <a href="/" class="text-gray-300 hover:text-primary-300 transition-colors">
                  About Us
                </a>
              </li>
              <li>
                <a href="/" class="text-gray-300 hover:text-primary-300 transition-colors">
                  I'm New
                </a>
              </li>
              <li>
                <a href="/" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Staff
                </a>
              </li>
              <li>
                <a href="/" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Contact
                </a>
              </li>
          </ul>
        </div>
        <div>
          <h4 class="text-lg font-bold mb-4 text-white">Resources</h4>
          <ul class="space-y-2">
              <li>
                <a href="/" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Sermons
                </a>
              </li>
              <li>
                <a href="/" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Events
                </a>
              </li>
              <li>
                <a href="/" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Blog
                </a>
              </li>
              <li>
                <a href="/" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Ministries
                </a>
              </li>
          </ul>
        </div>
        <div>
          <h4 class="text-lg font-bold mb-4 text-white">Connect</h4>
          <ul class="space-y-2">
              <li>
                <a href="/about-us" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Giving
                </a>
              </li>
              <li>
                <a href="/im-new" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Prayer Request
                </a>
              </li>
              <li>
                <a href="/about-us" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Newsletter
                </a>
              </li>
              <li>
                <a href="/im-new" class="text-gray-300 hover:text-primary-300 transition-colors">
                  Volunteer
                </a>
              </li>
          </ul>
        </div>
    </div>

    <!-- Copyright -->
    <div class="pt-8 mt-8 border-t border-gray-800 text-center text-gray-400 text-sm">
      <p>&copy; 2025 mcc. All rights reserved.</p>
      <p class="mt-2">
        <a href="/privacy-policy" class="hover:text-primary-300 mr-4">Privacy Policy</a>
        <a href="/terms-of-service" class="hover:text-primary-300">Terms of Service</a>
      </p>
    </div>
  </div>
</footer>



          <script src="/theme/js/main.js"></script>


    </div>
  </body>
</html>